# アイテムページUI改善設計書

## 概要
TVerのアイテムページを参考にして、TVappのアイテムページUIを改善します。
ユーザーエクスペリエンスを向上させるため、データ取得の非同期処理を最適化し、コンテンツの表示を改善します。

## 参照ページ
- TVer アイテムページ: https://tver.jp/episodes/ep6t0yi00r
- TVapp アイテムページ: http://localhost:3000/episode/ep6t0yi00r

## 現状分析

### 現在の実装（xiaovy.tvapp.web/src/app/episode/[episodeId]/page.tsx:11-107）
現在のアイテムページには以下の課題があります：

1. **データ取得の依存関係**
   - 動画URL（`videoUrl`）とエピソード情報（`episode`）の両方が取得されるまでローディング画面が表示される（46-48行目）
   - ユーザーは動画が読み込まれるまで、タイトルや説明などの基本情報を見ることができない

2. **動画プレイヤーのローディング表示**
   - プレイヤー領域は確保されているが（65-72行目）、動画取得中のローディングインジケーターがない
   - ユーザーは動画が読み込まれているかどうかが視覚的にわからない

3. **エピソードリストの欠如**
   - 同じシリーズの他のエピソードを見る手段がない
   - TVerではエピソードリストが表示され、ユーザーが簡単に他のエピソードに移動できる

4. **お気に入りボタンの配置**
   - ボタンは実装されているが、コンテンツの下部に配置されており、目立たない（95-101行目）
   - ユーザーがすぐにアクセスできる位置にない

## 要求事項と対応設計

### 要求1: 動画プレイヤーの領域確保とローディングインジケーター

**対応内容:**
- 動画プレイヤーコンポーネントを拡張し、`isLoading`プロップを追加
- ローディング中はスピナーまたはスケルトンローディングを表示
- プレイヤー領域は現在と同様にアスペクト比16:9で確保（65-72行目参照）

**理由:**
- ユーザーに動画が読み込まれていることを視覚的にフィードバック
- 待機中の不安を軽減し、UXを向上
- 既存のレイアウトを維持しつつ、ローディング状態を追加することで変更を最小限に抑える

**実装方針:**
```tsx
<div style={{
    width: '100vw',
    height: 'calc(100vw * 9 / 16)',
    position: 'relative',
    margin: 'auto',
    backgroundColor: '#000', // 動画プレイヤーの背景色
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center'
}}>
    {videoUrl ? (
        <VideoPlayer url={videoUrl.video_url} />
    ) : (
        <LoadingSpinner /> // ローディングインジケーター
    )}
</div>
```

### 要求2: 動画取得と他の情報表示の分離

**対応内容:**
- ローディング条件を変更し、エピソード情報のみが取得されれば基本情報を表示
- 動画URLの取得状態とエピソード情報の取得状態を独立して管理
- 現在の46-48行目の条件を修正

**修正前:**
```tsx
if (!videoUrl || !episode || !loginUser) {
    return <div>Loading...</div>;
}
```

**修正後:**
```tsx
if (!loginUser) {
    return <div>Loading...</div>;
}

// episodeがない場合のみローディング
if (!episode) {
    return <div>Loading...</div>;
}

// videoUrlは個別にローディング表示
```

**理由:**
- 動画の読み込みには時間がかかる場合があるが、エピソード情報は比較的速く取得できる
- ユーザーは動画を待っている間に、タイトル、説明、サムネイルなどを読むことができる
- パフォーマンスの向上と体感速度の改善につながる

### 要求3: エピソードリストの表示とカテゴリ分け

**対応内容:**
- シリーズAPIを呼び出してエピソードリストを取得
- 既存の`useSeries`フックと`convertCardContentsBySeason`関数を活用（xiaovy.tvapp.web/src/app/series/[seriesId]/page.tsx:14-57参照）
- カテゴリ（シーズン）ごとにタブまたはセクションで表示
- 各カテゴリは「すべて」「本編」「配信限定」などのseasonTitleで分類

**データ構造:**
シリーズAPI (`https://statics.tver.jp/content/series/${seriesId}.json`) のレスポンスには、
`result.contents`配列が含まれており、各要素には以下が含まれます：
- `seasonTitle`: カテゴリ名（例: "本編", "配信限定", "シーズン1"など）
- `contents`: エピソードの配列

**理由:**
- ユーザーが同じシリーズの他のエピソードを簡単に発見できる
- TVerと同様のUXを提供し、ユーザーの混乱を防ぐ
- シリーズの連続視聴を促進し、エンゲージメントを向上

**実装方針:**
```tsx
// シリーズデータを取得
const seriesContent = useSeriesService(episode.data.seriesID, session);
const seriesEpisodes = seriesContent ? convertCardContentsBySeason(seriesContent) : null;

// 表示
{seriesEpisodes && (
    <div>
        <h2>エピソード</h2>
        {seriesEpisodes.map((season, index) => (
            <div key={index}>
                <h3>{season.seasonTitle}</h3>
                <GenreContentCardList contents={season.contents} />
            </div>
        ))}
    </div>
)}
```

### 要求4: お気に入り登録ボタンの配置

**対応内容:**
- お気に入りボタンをタイトル付近またはサムネイルの右上に配置
- ボタンをより目立つデザインに変更（アイコンボタンまたは固定位置）
- スティッキーヘッダーとして画面上部に固定する選択肢も検討

**配置オプション:**
1. **タイトル横配置**: シリーズタイトルの右側にアイコンボタンとして配置
2. **固定ヘッダー**: 画面上部に固定し、スクロール時も表示
3. **動画プレイヤー上部**: プレイヤーの右上コーナーに配置

**推奨: タイトル横配置**

**理由:**
- ユーザーがシリーズ名を見てすぐにお気に入り登録できる
- TVerのUIパターンに近く、ユーザーの期待に沿う
- 視線の流れに沿った自然な配置

**実装方針:**
```tsx
<div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
    <a href={`/series/${episode.data.seriesID}`}>
        {seriesTitle}
    </a>
    <button
        onClick={() => handleFavoriteClick(seriesTitle, episode.data.seriesID)}
        className="favorite-button"
        aria-label={isFavorite ? 'お気に入り解除' : 'お気に入り登録'}
    >
        {isFavorite ? '★' : '☆'}
    </button>
</div>
```

## レイアウト構造

### 修正後のページ構造
```
┌─────────────────────────────────────┐
│   動画プレイヤー（16:9）             │
│   - ローディング時: スピナー表示      │
│   - 取得完了後: VideoPlayer表示      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ コンテンツ情報                       │
│ ┌───────────────────────────────┐   │
│ │ [シリーズタイトル] [★お気に入り]│   │
│ └───────────────────────────────┘   │
│   エピソードタイトル                 │
│   放送局 / 放送日                    │
│   説明文                             │
│   TVerリンク                         │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ エピソードリスト                     │
│ ┌───────────────────────────────┐   │
│ │ [本編] [配信限定] [シーズン1] │   │
│ └───────────────────────────────┘   │
│   エピソードカード × N               │
└─────────────────────────────────────┘
```

## 技術的考慮事項

### 1. 状態管理
- `videoUrl`: 動画URLの取得状態（null → データ）
- `episode`: エピソード情報の取得状態（null → データ）
- `seriesContent`: シリーズエピソード一覧の取得状態（null → データ）
- 各状態は独立して管理し、部分的なレンダリングを可能にする

### 2. パフォーマンス最適化
- エピソード情報とシリーズコンテンツは並列で取得可能
- 動画URLの取得は優先度を下げ、ページ表示をブロックしない
- カードリストの遅延ロードを検討（必要に応じて）

### 3. エラーハンドリング
- 各データ取得のエラーを個別に処理
- エラー時も他の情報は表示を継続
- ユーザーへの適切なエラーメッセージ表示

### 4. アクセシビリティ
- ローディング状態を`aria-busy`属性で通知
- お気に入りボタンに`aria-label`を設定
- キーボード操作のサポート

## API使用

### 必要なAPI
1. **エピソード情報API**: `/api/content/episode/[episodeId]`
   - 既存の実装を継続使用

2. **動画URL API**: `/api/service/call/episode`
   - 既存の実装を継続使用

3. **シリーズコンテンツAPI**: `/api/content/series/[seriesId]`
   - 既存の実装を活用
   - エピソード一覧の取得に使用

### データフロー
```
episodeId → callEpisodeInfo() → episode (基本情報)
                               → seriesID
                                      ↓
                               callSeriesContents() → seriesContent (エピソードリスト)

episodeId → callStreamUrl() → videoUrl (動画URL)
```

## 実装優先順位

優先度の高い順：
1. **HIGH**: 要求2 - 動画取得と情報表示の分離（UX改善の基盤）
2. **HIGH**: 要求1 - プレイヤーのローディング表示（視覚的フィードバック）
3. **MEDIUM**: 要求4 - お気に入りボタンの再配置（ユーザビリティ向上）
4. **MEDIUM**: 要求3 - エピソードリストの表示（機能追加）

## 備考
- 既存のコンポーネント（`VideoPlayer`, `GenreContentCardList`）を可能な限り再利用
- モバイルレスポンシブ対応も考慮（現在のスタイルは`vw`単位を使用）
- 将来的には、TailwindCSSを活用したより洗練されたスタイリングを検討
